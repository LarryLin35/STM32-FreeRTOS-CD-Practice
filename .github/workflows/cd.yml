name: STM32_Main_Production_Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: 1. æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ä»¥ä¾¿æ‰“ Tag

      - name: 2. åœ¨ Docker ä¸­ç·¨è­¯éŸŒé«”
        run: |
          docker run --rm -v $(pwd):/app -w /app \
          bitnami/minideb:latest \
          bash -c "apt-get update && apt-get install -y curl make gcc-arm-none-eabi && make"

      - name: 3. åŸ·è¡Œ Python éŸŒé«”æ‰“åŒ… (SHA-256)
        run: |
          python3 pack.py
          sha256sum firmware.bin > firmware.bin.sha256

      # --- ä»¥ä¸‹æ­¥é©Ÿåƒ…åœ¨ã€ŒçœŸæ­£æ¨é€åˆ° mainã€(åŒ…å« PR åˆä½µå¾Œ) æ‰åŸ·è¡Œ ---
      # PR éšæ®µåªæœƒè·‘ä¸Šé¢çš„ç·¨è­¯æ¸¬è©¦ï¼Œç¢ºä¿ä¸æœƒå£æ‰

      - name: 4. ç™»å…¥ GitHub Container Registry (GHCR)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 5. è™•ç† Image åç¨±è½‰å°å¯«
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "IMAGE_ID=$(echo ghcr.io/${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: 6. å°è£ä¸¦æ¨é€ Package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_ID }}:latest
            ${{ env.IMAGE_ID }}:v1.0.${{ github.run_number }}

      - name: 7. è‡ªå‹•ç”¢ç”Ÿ Release èˆ‡ Tag
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          # é€™è¡Œæœƒè‡ªå‹•å¹«ä½ å»ºç«‹ Git Tag
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: |
            firmware.bin
            production_package.bin
            firmware.bin.sha256
          body: |
            ## ğŸš€ æ­£å¼ç™¼ä½ˆå ±å‘Š
            - **ç‰ˆæœ¬è™Ÿ**: v1.0.${{ github.run_number }}
            - **åŸå§‹ SHA-256**: `$(cat firmware.bin.sha256 | awk '{print $1}')`
            - **æ‰“åŒ…èªªæ˜**: å·²åŒ…å« Magic Number èˆ‡æ ¡é©— Headerã€‚
          draft: false
          prerelease: false