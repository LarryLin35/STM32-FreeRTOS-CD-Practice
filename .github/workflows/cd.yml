# 1. è‡ªå‹•åŒ–æµç¨‹çš„åå­—ï¼šSTM32 ç”Ÿç”¢ç´šæŒçºŒéƒ¨ç½²æµç¨‹
name: STM32_FreeRTOS_Production_CD

# 2. è§¸ç™¼æ¢ä»¶ï¼šç•¶ main (æ­£å¼ç‰ˆ) æˆ– dev (é–‹ç™¼ç‰ˆ) åˆ†æ”¯æœ‰ push æ™‚å•Ÿå‹•
on:
  push:
    branches:
      - main
      - dev

# 3. å·¥ä½œä»»å‹™
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # è¨­ç½®åŸ·è¡Œæ¬Šé™ï¼šå…è¨±å¯«å…¥ GitHub Release èˆ‡ GitHub Packages (Docker Image)
    permissions:
      contents: write
      packages: write

    steps:
      # ç¬¬ä¸€æ­¥ï¼šä¸‹è¼‰åŸå§‹ç¢¼
      - name: 1. æª¢å‡ºç¨‹å¼ç¢¼ (Checkout)
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Docker é€²è¡Œäº¤å‰ç·¨è­¯
      # æˆ‘å€‘åœ¨é€™è£¡ç”¢å‡ºæœ€åŸå§‹çš„ firmware.bin
      - name: 2. åœ¨ Docker ä¸­ç·¨è­¯åŸå§‹éŸŒé«”
        run: |
          docker run --rm -v $(pwd):/app -w /app \
          bitnami/minideb:latest \
          bash -c "
            apt-get update && \
            apt-get install -y curl make gcc-arm-none-eabi && \
            make
          "
          # è¨»ï¼šç·¨è­¯å®Œæˆå¾Œï¼Œå·¥ä½œç›®éŒ„ä¸‹æ‡‰å‡ºç¾ firmware.bin

      # --- é—œéµæ–°å¢æ­¥é©Ÿï¼šåŸ·è¡Œæ‰“åŒ…èˆ‡æ ¡é©— ---
      # é€™è£¡æœƒè·‘ä½ çš„ pack.pyï¼ŒæŠŠ Magic Number å’Œ SHA-256 é»ä¸Šå»
      - name: 3. åŸ·è¡Œ Python æ‰“åŒ…èˆ‡ SHA-256 è¨ˆç®—
        run: |
          # åŸ·è¡Œä½ å¯«çš„æ‰“åŒ…è…³æœ¬ï¼Œç”¢å‡º production_package.bin
          python3 pack.py
          
          # å¦å¤–ç”¢ç”Ÿä¸€å€‹ç´”æ–‡å­—çš„æ ¡é©—æª”ï¼Œæ–¹ä¾¿äººé¡ç›´æ¥åœ¨ç¶²é ä¸Šçœ‹
          sha256sum firmware.bin > firmware.bin.sha256
          echo "æ‰“åŒ…å®Œæˆï¼SHA-256 æŒ‡ç´‹ç‚ºï¼š"
          cat firmware.bin.sha256

      # ç¬¬å››æ­¥ï¼šç™»å…¥ GitHub å®¹å™¨è¨»å†Šè¡¨
      - name: 4. ç™»å…¥ GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äº”æ­¥ï¼šè™•ç†å‘½åè¦ç¯„
      - name: 5. è™•ç† Image åç¨±è½‰ç‚ºå°å¯«
        run: |
          echo "IMAGE_ID=$(echo ghcr.io/${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # ç¬¬å…­æ­¥ï¼šå°è£ Image ä¸¦æ¨é€
      # æ³¨æ„ï¼šDockerfile æœƒæŠŠç·¨è­¯ç”¢å‡ºçš„æª”æ¡ˆåŒ…é€²å»
      - name: 6. å°è£ä¸¦æ¨é€ Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_ID }}:latest
            ${{ env.IMAGE_ID }}:${{ github.sha }}

      # ç¬¬ä¸ƒæ­¥ï¼šç™¼ä½ˆæ­£å¼ç‰ˆæœ¬ (åƒ…é™ main åˆ†æ”¯)
      # ç•¶ä½ å¾ dev åˆä½µåˆ° main æ™‚ï¼Œé€™æ­¥æœƒæŠŠã€Œèº«åˆ†è­‰åŒ…ã€æ›ä¸Šå»
      - name: 7. ç”¢ç”Ÿ GitHub Release (åƒ…é™ main åˆ†æ”¯)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          # åŒæ™‚ä¸Šå‚³ä¸‰ç¨®æª”æ¡ˆï¼Œæ»¿è¶³ä¸åŒéœ€æ±‚
          files: |
            firmware.bin
            production_package.bin
            firmware.bin.sha256
          # åœ¨ Release é é¢ç›´æ¥é¡¯ç¤ºèªªæ˜å…§å®¹ï¼Œä¸ç”¨ä¸‹è¼‰ä¹Ÿèƒ½å°å¸³
          body: |
            ### ğŸš€ è‡ªå‹•åŒ–ç·¨è­¯å ±å‘Š
            - **åŸå§‹æª”æ¡ˆ SHA-256**: `$(cat firmware.bin.sha256 | awk '{print $1}')`
            - **OTA å°ˆç”¨åŒ…**: `production_package.bin` (å« Magic Number 0xABCD1234)
            - **ç·¨è­¯æ™‚é–“**: ${{ github.event.head_commit.timestamp }}
            - **Commit ID**: ${{ github.sha }}
          draft: false
          prerelease: false
